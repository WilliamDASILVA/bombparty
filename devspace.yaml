version: v1beta9
images:
  back:
    image: williamdasilva/bombparty-back
    dockerfile: ./apps/back/Dockerfile
    context: ./apps/back
    preferSyncOverRebuild: true
    injectRestartHelper: true
    build:
      docker:
        options:
          target: release

  dictionnary:
    image: williamdasilva/bombparty-dictionnary
    dockerfile: ./apps/dictionnary/Dockerfile
    context: ./apps/dictionnary
    preferSyncOverRebuild: true
    injectRestartHelper: true
    build:
      docker:
        options:
          target: release

  app:
    image: williamdasilva/bombparty-app
    dockerfile: ./apps/app/Dockerfile
    context: ./apps/app
    preferSyncOverRebuild: true
    injectRestartHelper: true
    build:
      docker:
        options:
          target: release
          buildArgs:
            VUE_MODE: prod

deployments:
- name: back
  helm:
    componentChart: true
    values:
      replicas: 2
      rollingUpdate:
        enabled: true
        maxSurge: "100%"
        maxUnavailable: "50%"
      containers:
      - image: williamdasilva/bombparty-back
        env:
        - name: PORT
          value: "3000"
      ingress:
        annotations:
          kubernetes.io/ingress.class: nginx
          cert-manager.io/cluster-issuer: ls-back-prod
          nginx.ingress.kubernetes.io/upstream-hash-by: "$host"
          nginx.ingress.kubernetes.io/proxy-read-timeout: 3600
          nginx.ingress.kubernetes.io/proxy-send-timeout: 3600
          nginx.ingress.kubernetes.io/configuration-snippet: |
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

        tls: ls-back-prod
        tlsClusterIssuer: ls-back-prod
        ingressClass: nginx
        rules:
        - host: api.bombparty.xyz
      service:
        ports:
        - port: 3000

- name: app
  helm:
    componentChart: true
    values:
      replicas: 2
      rollingUpdate:
        enabled: true
        maxSurge: "100%"
        maxUnavailable: "50%"
      containers:
      - image: williamdasilva/bombparty-app
        env:
        - name: HOST
          value: "0.0.0.0"
        - name: PORT
          value: "8081"
      ingress:
        annotations:
          kubernetes.io/ingress.class: nginx
          cert-manager.io/cluster-issuer: ls-app-prod
        tls: ls-app-prod
        tlsClusterIssuer: ls-app-prod
        ingressClass: nginx
        rules:
        - host: www.bombparty.xyz
        - host: bombparty.xyz
      service:
        ports:
        - port: 8081

- name: dictionnary
  helm:
    componentChart: true
    values:
      replicas: 2
      rollingUpdate:
        enabled: true
        maxSurge: "100%"
        maxUnavailable: "50%"
      containers:
      - image: williamdasilva/bombparty-dictionnary
        env:
        - name: HOST
          value: "0.0.0.0"
      service:
        type: ClusterIP
        ports:
        - port: 3010
